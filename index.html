<html>
  <head>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/vue/2.6.12/vue.min.js"
      integrity="sha512-BKbSR+cfyxLdMAsE0naLReFSLg8/pjbgfxHh/k/kUC82Hy7r6HtR5hLhobaln2gcTvzkyyehrdREdjpsQwy2Jw=="
      crossorigin="anonymous"
    ></script>
    <!-- Load TensorFlow.js -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <!-- Load Posenet -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/posenet"></script>
    <style>
      canvas{display:none}
      video{display:none}

    </style>
  </head>

  <body>
    <div id="app">
      <video id="player" autoplay></video>
      <canvas id="snapshot" width="320" height="320"></canvas>
      <svg width="320" height="320">
        <circle :cx="head.x" :cy="head.y" :r="head.r"></circle>
        <polyline
          stroke-linejoin="round"
          stroke="black"
          stroke-width="40"
          :points="armStr"
          fill="none"
        ></polyline>
        <polyline
          stroke-linejoin="round"
          stroke="black"
          stroke-width="40"
          :points="spineStr"
          fill="none"
        ></polyline>
        <polyline
          stroke-linejoin="round"
          stroke="black"
          stroke-width="40"
          :points="legStr"
          fill="none"
        ></polyline>
      </svg>
      <svg width="320" height="320">
        <circle :cx="head.x" :cy="head.y" :r="head.r"></circle>
        <polyline
          stroke-linejoin="round"
          stroke="black"
          stroke-width="40"
          :points="armStr"
          fill="none"
        ></polyline>
        <polyline
          stroke-linejoin="round"
          stroke="black"
          stroke-width="40"
          :points="spineStr"
          fill="none"
        ></polyline>
        <polyline
          stroke-linejoin="round"
          stroke="black"
          stroke-width="40"
          :points="legStr"
          fill="none"
        ></polyline>
      </svg>
      <svg width="320" height="320">
        <circle :cx="head.x" :cy="head.y" :r="head.r"></circle>
        <polyline
          stroke-linejoin="round"
          stroke="black"
          stroke-width="40"
          :points="armStr"
          fill="none"
        ></polyline>
        <polyline
          stroke-linejoin="round"
          stroke="black"
          stroke-width="40"
          :points="spineStr"
          fill="none"
        ></polyline>
        <polyline
          stroke-linejoin="round"
          stroke="black"
          stroke-width="40"
          :points="legStr"
          fill="none"
        ></polyline>
      </svg>
    </div>
  </body>
  <!-- Place your code in the script tag below. You can also use an external .js file -->
  <script>
    const dst = (a, b) =>
      Math.pow(
        Math.pow(a.position.x - b.position.x, 2) +
          Math.pow(a.position.y - b.position.y, 2),
        0.5
      );
    const avg = (a, b) => {
      return {
        position: {
          x: (a.position.x + b.position.x) / 2,
          y: (a.position.y + b.position.y) / 2,
        },
        score: Math.min(a.score + b.score),
      };
    };
    const toPoints = (p) => {
      return p.filter(i => i.score > 0.1).map((i) => `${i.position.x},${i.position.y}`).join(" ");
    };
    let init = {
      position: { x: 0, y: 0 },
      score: 0,
    };

    new Vue({
      el: "#app",
      data() {
        return {
          nose: init,
          leftEye: init,
          rightEye: init,
          leftEar: init,
          rightEar: init,
          leftShoulder: init,
          rightShoulder: init,
          leftElbow: init,
          rightElbow: init,
          leftWrist: init,
          rightWrist: init,
          leftHip: init,
          rightHip: init,
          leftKnee: init,
          rightKnee: init,
          leftAnkle: init,
          rightAnkle: init,
        };
      },
      computed: {
        arm() {
          return [
            this.leftWrist,
            this.leftElbow,
            this.leftShoulder,
            this.rightShoulder,
            this.rightElbow,
            this.rightWrist,
          ];
        },
        leg() {
          return [
            this.leftAnkle,
            this.leftKnee,
            this.hip,
            this.rightKnee,
            this.rightAnkle,
          ];
        },
        legStr() {
          return toPoints(this.leg);
        },
        spine() {
          return [this.nose, this.neck, this.hip];
        },
        spineStr() {
          return toPoints(this.spine);
        },
        armStr() {
          return toPoints(this.arm);
        },
        neck() {
          return avg(this.leftShoulder, this.rightShoulder);
        },
        hip() {
          return avg(this.leftHip, this.rightHip);
        },
        head() {
          return {
            x: this.nose.position.x,
            y: this.nose.position.y,
            r: Math.max(dst(this.leftShoulder, this.rightShoulder) / 2, dst(this.neck, this.nose) *0.7),
          };
        },
      },
      mounted() {
        let net = null;
        posenet
          .load()
          .then(function (_net) {
            net = _net;
            console.log("loaded");
          })
          .then(function (poses) {
            console.log(poses);
          });

        let player = document.getElementById("player");
        let snapshotCanvas = document.getElementById("snapshot");
        let width = snapshotCanvas.width;
        let height = snapshotCanvas.height;

        // Hey frontend guys, I reinvented jQuery
        const $ = (pose, part) => pose.keypoints.find((i) => i.part === part);

        let startScan = (callback) => {
          const ctx = snapshotCanvas.getContext("2d");
          let intervalHandler = setInterval(() => {
            ctx.drawImage(player, 0, 0, width, height);
            // ctx.clearRect(0, 0, width, height);
            const imageData = ctx.getImageData(0, 0, width, height);
            if (net) {
              net
                .estimateSinglePose(imageData, {
                  flipHorizontal: true,
                  scoreThreshold: 0.6,
                  nmsRadius: 20,
                })
                .then((pose) => {
                  this.nose = $(pose, "nose");
                  this.leftEye = $(pose, "leftEye");
                  this.rightEye = $(pose, "rightEye");
                  this.leftEar = $(pose, "leftEar");
                  this.rightEar = $(pose, "rightEar");
                  this.leftShoulder = $(pose, "leftShoulder");
                  this.rightShoulder = $(pose, "rightShoulder");
                  this.leftElbow = $(pose, "leftElbow");
                  this.rightElbow = $(pose, "rightElbow");
                  this.leftWrist = $(pose, "leftWrist");
                  this.rightWrist = $(pose, "rightWrist");
                  this.leftHip = $(pose, "leftHip");
                  this.rightHip = $(pose, "rightHip");
                  this.leftKnee = $(pose, "leftKnee");
                  this.rightKnee = $(pose, "rightKnee");
                  this.leftAnkle = $(pose, "leftAnkle");
                  this.rightAnkle = $(pose, "rightAnkle");
                });
            }
          }, 50);
        };

        let handleSuccess = function (stream) {
          // カメラストリームをプレイヤーのデータに設定
          player.srcObject = stream;

          startScan((scanResult) => {
            // このページの呼び出し元に読み取り結果を返す
          });
        };

        // このメソッドを呼び出すことでユーザーにブラウザがカメラを使用することを許可するかの確認ダイアログが表示され、
        // 許可されれば handleSuccess が呼ばれる
        navigator.mediaDevices
          .getUserMedia({
            video: { facingMode: "environment", width: width, height: height },
            audio: false,
          })
          .then(handleSuccess)
          .catch((err) => {
            console.log(JSON.stringify(err));
          });
      },
    });
  </script>
</html>
